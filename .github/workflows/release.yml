name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  DOTNET_VERSION: "8.0.x"
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Get version and tag info
        id: info
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT
          
          # Get tag message for annotated tags
          $tagType = git cat-file -t $tag 2>$null
          if ($tagType -eq "tag") {
            $tagContent = git cat-file tag $tag
            $inMessage = $false
            $messageLines = @()
            foreach ($line in $tagContent) {
              if ($inMessage) { $messageLines += $line }
              elseif ($line -eq "") { $inMessage = $true }
            }
            $tagMessage = $messageLines -join "`n"
            if ($tagMessage.Trim()) {
              $delimiter = "EOF_$(Get-Random)"
              echo "TAG_MESSAGE<<$delimiter" >> $env:GITHUB_OUTPUT
              echo "$tagMessage" >> $env:GITHUB_OUTPUT
              echo "$delimiter" >> $env:GITHUB_OUTPUT
              return
            }
          }
          echo "TAG_MESSAGE=" >> $env:GITHUB_OUTPUT

      - name: Setup Inno Setup
        id: inno
        run: |
          choco install innosetup --yes --no-progress
          
          # Find Inno Setup path
          $paths = @(
            "C:\Program Files (x86)\Inno Setup 6",
            "C:\Program Files\Inno Setup 6"
          )
          foreach ($p in $paths) {
            if (Test-Path "$p\ISCC.exe") {
              echo "PATH=$p" >> $env:GITHUB_OUTPUT
              
              # Download Chinese language files
              $langDir = "$p\Languages"
              @("ChineseSimplified", "ChineseTraditional") | ForEach-Object {
                $file = "$langDir\$_.isl"
                if (-not (Test-Path $file)) {
                  $url = "https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/Unofficial/$_.isl"
                  Invoke-WebRequest -Uri $url -OutFile $file -UseBasicParsing -ErrorAction SilentlyContinue
                }
              }
              return
            }
          }
          Write-Error "Inno Setup not found"
          exit 1

      - name: Build and publish
        run: |
          dotnet publish FlipSwitcher/FlipSwitcher.csproj `
            -c Release -r win-x64 --self-contained true `
            -p:PublishSingleFile=false `
            -p:DebugType=None `
            -p:DebugSymbols=false `
            -p:Version=${{ steps.info.outputs.VERSION }} `
            -o publish/setup

      - name: Build installer
        run: |
          $version = "${{ steps.info.outputs.VERSION }}"
          $innoPath = "${{ steps.inno.outputs.PATH }}"
          
          & "$innoPath\ISCC.exe" `
            /DVersion="$version" `
            /DPublishDir="$(Join-Path $PWD 'publish/setup')" `
            "FlipSwitcher\FlipSwitcher.iss"
          
          if ($LASTEXITCODE -ne 0) { exit 1 }
          
          # Create versioned copy and checksum
          $installer = "publish/FlipSwitcher-windows-x64-Setup.exe"
          $versionedInstaller = "publish/FlipSwitcher-$version-windows-x64-Setup.exe"
          Copy-Item $installer $versionedInstaller
          
          # Generate SHA256 checksum
          $hash = (Get-FileHash $versionedInstaller -Algorithm SHA256).Hash
          "$hash  FlipSwitcher-$version-windows-x64-Setup.exe" | Out-File "publish/SHA256SUMS.txt" -Encoding utf8

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.info.outputs.TAG }}
          body: ${{ steps.info.outputs.TAG_MESSAGE }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            publish/FlipSwitcher-${{ steps.info.outputs.VERSION }}-windows-x64-Setup.exe
            publish/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
