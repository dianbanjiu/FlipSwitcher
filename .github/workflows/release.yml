name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Get version from tag
        id: get_version
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset --yes --no-progress

      - name: Restore dependencies
        run: dotnet restore FlipSwitcher/FlipSwitcher.csproj

      # Self-contained version with runtime
      - name: Build Self-Contained
        run: |
          dotnet publish FlipSwitcher/FlipSwitcher.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:DebugType=None -p:DebugSymbols=false -p:Version=${{ steps.get_version.outputs.VERSION }} -o publish/self-contained

      - name: Rename Self-Contained exe
        run: |
          Move-Item -Path publish/self-contained/FlipSwitcher.exe -Destination publish/FlipSwitcher-windows-x64-SelfContained.exe

      - name: Create Self-Contained zip
        run: |
          Compress-Archive -Path publish/FlipSwitcher-windows-x64-SelfContained.exe -DestinationPath publish/FlipSwitcher-windows-x64-SelfContained.exe.zip

      # MSI Installer
      - name: Build for MSI
        run: |
          dotnet publish FlipSwitcher/FlipSwitcher.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -p:DebugType=None -p:DebugSymbols=false -p:Version=${{ steps.get_version.outputs.VERSION }} -o publish/msi

      - name: Build MSI Installer
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          # Find WiX installation path
          $wixPath = $null
          $possiblePaths = @(
            "C:\Program Files (x86)\WiX Toolset v3.11\bin",
            "C:\Program Files\WiX Toolset v3.11\bin",
            "C:\Program Files (x86)\WiX Toolset v3.14\bin",
            "C:\Program Files\WiX Toolset v3.14\bin"
          )
          foreach ($path in $possiblePaths) {
            if (Test-Path "$path\candle.exe") {
              $wixPath = $path
              break
            }
          }
          if (-not $wixPath) {
            # Try to find from PATH
            $candlePath = Get-Command candle.exe -ErrorAction SilentlyContinue
            if ($candlePath) {
              $wixPath = Split-Path $candlePath.Source
            } else {
              Write-Error "WiX Toolset not found. Please install it."
              exit 1
            }
          }
          Write-Host "Using WiX Toolset from: $wixPath"
          $publishDir = Join-Path $PWD "publish"
          $msiDir = Join-Path $publishDir "msi"
          $wxsDir = Join-Path $PWD "FlipSwitcher"

          # Generate file list using Heat (64-bit)
          & "$wixPath\heat.exe" dir "$msiDir" -cg ProductFiles -gg -sfrag -srd -scom -sreg -platform x64 -dr INSTALLFOLDER -var var.PublishDir -out "$publishDir\ProductFiles.wxs"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Heat failed"
            exit 1
          }

          # Compile WiX files
          & "$wixPath\candle.exe" -nologo -arch x64 -dVersion="$version" -dPublishDir="$msiDir" "$wxsDir\FlipSwitcher.wxs" "$publishDir\ProductFiles.wxs" -out "$publishDir\"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "WiX compilation failed"
            exit 1
          }

          # Link and create MSI
          & "$wixPath\light.exe" -nologo -ext WixUIExtension -out "$publishDir\FlipSwitcher-windows-x64.msi" "$publishDir\FlipSwitcher.wixobj" "$publishDir\ProductFiles.wixobj"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "WiX linking failed"
            exit 1
          }

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.get_version.outputs.TAG }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            publish/FlipSwitcher-windows-x64-SelfContained.exe.zip
            publish/FlipSwitcher-windows-x64.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
